# System Metrics Exporter for Prometheus

## Описание

Экспортёр собирает системные метрики об использовании процессоров, оперативной памяти и дискового пространства. Метрики предоставляются в формате, совместимом с Prometheus, и доступны по корневому пути `/`. Экспортёр может быть использован для построения графиков, создания предупреждений и анализа тенденций производительности системы.

## Установка

### Шаг 1: Клонирование репозитория и установка зависимостей

```
git clone https://github.com/B1ondyyy/utmn_otrpo_lab10.git
cd utmn_otrpo_lab10
```

```
pip install -r requirements.txt
```
### Шаг 2: Настройка переменных окружения

Экспортёр использует переменные окружения EXPORTER_HOST и EXPORTER_PORT для определения хоста и порта, на которых он будет работать. По умолчанию используются значения 0.0.0.0 и 8000 соответственно.

**Для Windows (CMD):**

```
set EXPORTER_HOST=0.0.0.0
set EXPORTER_PORT=8000
```
Если вы не установите эти переменные, по умолчанию будут использованы 0.0.0.0 и 8000.

### Шаг 3: Установка и настройка Prometheus

Скачайте Prometheus (Если у вас его ещё нет) с официального сайта и разархивируйте в удобную вам директорию.
Откройте файл конфигурации Prometheus prometheus.yml и добавьте следующий блок:

```
scrape_configs:
  - job_name: 'custom_exporter'
    metrics_path: '/'  # Указываем путь, где экспортёр предоставляет метрики
    static_configs:
      - targets: ['localhost:8000']  # Адрес и порт вашего экспортера
```

После внесения изменений, перезапустите Prometheus, чтобы он подхватил новую конфигурацию. Откройте файл prometheus.exe или впишите в терминал, заранее указав путь до папки с prometheus, команду:

```
prometheus.exe --config.file=prometheus.yml
```
### Шаг 4: Запуск программы

Запустите экспортёр с помощью следующей команды:

```
python main.py
```
Вы должны увидеть сообщение:

```
Exporter работает на http://0.0.0.0:8000/
Prometheus доступен по адресу http://localhost:9090/
```

Перейдите по локальному адресу.

## Метрики

- **`cpu_usage_percentage`**: Процент использования процессоров по ядрам.
- **`memory_total_bytes`**: Общий объем оперативной памяти.
- **`memory_used_bytes`**: Используемая оперативная память.
- **`disk_total_bytes`**: Общий объем дискового пространства.
- **`disk_used_bytes`**: Используемое дисковое пространство.

## PromQL Запросы

### 1. Использование процессоров

**Использование процессоров (по всем ядрам):**

```promql
avg(cpu_usage_percentage) by (core)
```

запрос покажет среднее использование процессоров по всем ядрам. 

[![all-cpu.png](https://i.postimg.cc/44HfRP3m/all-cpu.png)](https://postimg.cc/14PhppwQ)

Если вам нужно использование каждого ядра отдельно, запрос будет следующим:

```
cpu_usage_percentage
```

### 2. Оперативная память

**Память: всего и используется (совместный запрос):**

 Объединим два показателя — общий объем памяти и используемую память.

```
(memory_used_bytes / memory_total_bytes) * 100
```

Запрос покажет процент использования памяти, исходя из общего объема и используемой части.

[![all-memory.png](https://i.postimg.cc/ZqDS1vt8/all-memory.png)](https://postimg.cc/JyJvXnh0)

### 3. Дисковое постранство

**Объем дисков: общий и используемый (по всем дискам):**

Аналогично с процессорами, запрос охватывает все диски. Здесь мы также использовуем агрегирующую функцию для получения общего объема и объема, который занят.

```
avg(disk_used_bytes) by (device) / avg(disk_total_bytes) by (device) * 100
```

Запрос покажет процент использования дисков на всех устройствах.

[![all-sata.png](https://i.postimg.cc/6pWxqfBV/all-sata.png)](https://postimg.cc/1fjjY6n4)
